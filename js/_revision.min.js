"use strict";dotclear.revisionExpander=()=>{$.expandContent({lines:$("#revisions-list tr.line"),callback:dotclear.viewRevisionContent})},dotclear.viewRevisionContent=(e,t="toggle")=>{if(null==$(e).attr("id"))return;const n=$(e).attr("id").substr(1),i=$("#id").val();let s=document.getElementById(`re${n}`);s?($(s).toggle(),$(e).toggleClass("expand")):dotclear.servicesGet("getPatch",(t=>{const i=(new DOMParser).parseFromString(t,"text/xml"),r=$(i).children("rsp")[0];if("ok"==r.attributes[0].value){s=document.createElement("tr"),s.id=`re${n}`;const t=document.createElement("td");t.colSpan=$(e).children("td").length,t.className="expand",s.appendChild(t);let i,l;if("xhtml"==$("#post_format").get(0).value?(i=$(r).find("post_excerpt_xhtml").children(),l=$(r).find("post_content_xhtml").children()):(i=$(r).find("post_excerpt").children(),l=$(r).find("post_content").children()),0==i.length&&0==l.length)$(t).append(`<strong>${dotclear.dcrevisions.msg.content_identical}</strong>`);else{let e='<table class="preview-rev">';e+=dotclear.viewRevisionRender(i,dotclear.dcrevisions.msg.excerpt,n),e+=dotclear.viewRevisionRender(l,dotclear.dcrevisions.msg.content,n),e+="</table>",$(t).append(e)}$(e).addClass("expand"),e.parentNode.insertBefore(s,e.nextSibling)}else $(e).toggleClass("expand"),window.alert($(r).find("message").text())}),{pid:i,rid:n,type:dotclear.dcrevisions.post_type})},dotclear.viewRevisionRender=(e,t)=>{let n="",i="";return e.each((function(t){const s=this.nodeName,r=$(this).text();let l=$(this).attr("oline")??"",o=$(this).attr("nline")??"";"skip"==s&&(l=o="&hellip;");let a=["skip","context","insert","delete"].includes(s)?` ${s}`:"";s==i||""!=i&&"context"!=i||(a+=" first");const d=e.length>t+1?e.get(t+1).nodeName:"";s!=d&&"insert"!=d&&"delete"!=d&&(a+=" last"),i=s,n+=`<tr>\n    <td class="minimal col-line">${l}</td>\n    <td class="minimal col-line">${o}</td>\n    <td class="${a}">${r}</td>\n    </tr>\n    `})),""!=n?`<thead>\n      <tr class="rev-header">\n       <th colspan="3">${t}</th>\n      </tr>\n      <tr class="rev-number">\n       <th class="minimal nowrap">${dotclear.dcrevisions.msg.current}</th>\n       <th class="minimal nowrap">${dotclear.dcrevisions.msg.revision}</th>\n       <th class="maximal"></th>\n      </tr>\n    </thead>\n    <tbody>\n    ${n}\n    </tbody>\n    `:""},$((()=>{dotclear.dcrevisions=dotclear.getData("dcrevisions"),$("#edit-entry").on("onetabload",(()=>{$("#revisions-area label").toggleWithLegend($("#revisions-area").children().not("label"),{user_pref:"dcx_post_revisions",legend_click:!0,fn:dotclear.revisionExpander()}),$("#revisions-list tr.line a.patch").on("click",(()=>window.confirm(dotclear.dcrevisions.msg.confirm_apply_patch))),$("#revpurge").on("click",(()=>window.confirm(dotclear.dcrevisions.msg.confirm_purge_revision)))}))}));
